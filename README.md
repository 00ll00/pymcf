# PYMCF | py â¡ï¸ mcfunction

**ç‰ˆæœ¬ï¼š0.1.0-alpha**

python 3.13

minecraft (je) 1.21.8 ï¼ˆå…¶ä½™ç‰ˆæœ¬æœªæµ‹è¯•ï¼‰

## ç®€ä»‹

é€šè¿‡ç¼–å†™ python ä»£ç ç”Ÿæˆ MC æ•°æ®åŒ…ï¼ˆä»¥ mcfunction ç”Ÿæˆä¸ºæ ¸å¿ƒåŠŸèƒ½ï¼‰ï¼Œæ‹¥æœ‰å‡½æ•°è°ƒç”¨ï¼Œæµç¨‹æ§åˆ¶ï¼Œè®¡åˆ†æ¿è®¡ç®—ç­‰å¸¸è§„åŠŸèƒ½ï¼Œä»¥åŠå†…è”å‘½ä»¤ï¼Œç¼–è¯‘æœŸè®¡ç®—ï¼Œæ¡ä»¶ç¼–è¯‘ç­‰å®ç”¨åŠŸèƒ½ã€‚

æ­¤å¤–ï¼Œç”±äº pymcf å¼€å‘æ•°æ®åŒ…æ˜¯å®Œå…¨ä½¿ç”¨ python è¯­æ³•å¼€å‘ï¼Œå¯ä»¥å¾—åˆ°å¤§å¤šæ•°ç¼–è¾‘å™¨çš„é«˜äº®å’Œè¡¥å…¨æ”¯æŒ*ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œæˆ–å¯¼å°†ä½ å¼€å‘çš„å†…å®¹å¯¼å‡ºä¸ºä»£ç åº“ä¾›ä»–äººè°ƒç”¨ã€‚

_\* ç”±äº pymcf éƒ¨åˆ†è¯­å¥è¯­ä¹‰ä¸ python ä¸åŒï¼Œé«˜äº®å’Œç±»å‹æ¨æ–­åŠŸèƒ½å¯èƒ½ä¸å‡†ç¡®ã€‚_

## å®‰è£…

åœ¨ GitHub ä»“åº“çš„ release é¡µé¢ä¸‹è½½æœ€æ–°çš„ whl æ–‡ä»¶ï¼Œä½¿ç”¨ `pip install xxx.whl` è¿›è¡Œå®‰è£…ã€‚

## ç‰¹æ€§åˆ—è¡¨

- è¯­è¨€ç‰¹æ€§
    - å†…è”å‘½ä»¤
    - åˆ¤æ–­è¯­å¥
    - è¿­ä»£è¯­å¥
    - æ¡ä»¶å¾ªç¯è¯­å¥
    - å¼‚å¸¸å¤„ç†
    - å‡½æ•°æ”¯æŒ*
    - å®å‡½æ•°æ”¯æŒ**
    - å¼‚æ­¥å‡½æ•°æ”¯æŒ**
    - å¼•ç”¨/å¯¼å‡ºä»£ç åº“
    - ç¼–è¯‘æœŸè®¡ç®—
    - ç¼–è¯‘æœŸæ¡ä»¶åˆ†æ”¯
    - ç¼–è¯‘æœŸå¾ªç¯å±•å¼€
- æ ‡å‡†åº“
    - è®¡åˆ†æ¿å˜é‡åŠå…¶è¿ç®—æ”¯æŒ
    - nbt è®¿é—®æ”¯æŒ
    - ç›®æ ‡é€‰æ‹©å™¨
    - execute ä¸Šä¸‹æ–‡åˆ‡æ¢
    - å®ä½“æ•°æ®ç»“æ„**
    - æ›´å¤šæ•°å­¦è®¡ç®—**
- ç¼–è¯‘å™¨
    - å‡½æ•°å†…è”
    - ç¼–è¯‘ä¼˜åŒ–*
    - å‡½æ•°è°ƒç”¨æ ˆ**
    - ä¸åŒ MC ç‰ˆæœ¬çš„å‰åç«¯**
    - ast å¯è§†åŒ–
    - ir å¯è§†åŒ–
    - ç”Ÿæˆè°ƒè¯•ä¿¡æ¯*
    - æ•°æ®åŒ…ç”Ÿæˆ

_\* : æœªå®Œå…¨æ”¯æŒæˆ–éƒ¨åˆ†åŠŸèƒ½æœªå®ç°_

_\*\* : è®¡åˆ’ä¸­_

## è¯­è¨€æ–‡æ¡£

å‚è€ƒ[è¯­è¨€æ–‡æ¡£](doc/lang.md)ã€‚

## æ•™ç¨‹

æš‚æ—¶æ²¡æœ‰ï¼Œä¸è¿‡å¯ä»¥å‚è€ƒæ¦‚å¿µéªŒè¯å·¥ç¨‹ [psinmc](https://github.com/00ll00/psinmc) ğŸƒâ€â™‚ï¸ã€‚

## ç¤ºä¾‹

ä»¥ä¸‹æ˜¯åº·å¨ç”Ÿå‘½æ¸¸æˆçš„å®ç°ä»£ç ï¼ŒåŠ è½½ååœ¨ä¸»ä¸–ç•Œ 0, 100, 0 å¤„ç”Ÿæˆç”»å¸ƒï¼›ä½¿ç”¨èƒ¡èåœé’“ç«¿æ—¶å³é”®å¯ä»¥æ”¹å˜è§†çº¿æŒ‡å‘çš„ç»†èƒçš„çŠ¶æ€ï¼ŒQ é”®æ§åˆ¶æ¸¸æˆå¼€å§‹æˆ–æš‚åœï¼›`/reload`å‘½ä»¤å¯ä»¥é‡ç½®æ¸¸æˆã€‚

```python3
from pathlib import Path

from pymcf.entity import Marker, Player
from pymcf.mc.commands import AtS
from pymcf.project import Project
from pymcf.mcfunction import mcfunction, execute
from pymcf.data import Score, ScoreBoard
from pymcf.text import text_component

project = Project(
  name="gol",
  # prj_install_dir = Path("<æ•°æ®åŒ…å¯¼å‡ºè·¯å¾„>"),  # é»˜è®¤å¯¼å‡ºä½ç½®æ˜¯åŒç›®å½•ä¸‹ pymcf_out æ–‡ä»¶å¤¹
)

# ===============================

BLOCK_EMPTY = "minecraft:black_concrete"
BLOCK_FILLED = "minecraft:white_concrete"

W = 100  # ç”»å¸ƒå®½
L = 100  # ç”»æ¿é•¿
assert W * L <= 32768, "ç”»å¸ƒè¿‡å¤§"

MIN_NEB = 2  # ç»†èƒå­˜æ´»æœ€å°‘é‚»å±…æ•°
MAX_NEB = 3  # ç»†èƒå­˜æ´»æœ€å¤šé‚»å±…æ•°
NEW_NEB = 3  # ç»†èƒç¹æ®–éœ€è¦çš„é‚»å±…æ•°

MAX_DIST = 100  # æœ€è¿œå…‰æ ‡è·ç¦»

running = Score("$running", "gol")  # æ¸¸æˆæ˜¯å¦è¿è¡Œ


class Cell(Marker):
  """
  ç»†èƒå®ä½“ï¼Œç»§æ‰¿äº Marker
  """

  @mcfunction
  def try_expand(self):
    """
    åœ¨å›´æ ¼å­ç”Ÿæˆæ–°çš„ç»†èƒï¼Œè‹¥å·²æœ‰ç»†èƒæˆ–è¶…å‡ºç”»æ¿èŒƒå›´åˆ™è·³è¿‡
    """
    tmp = Score()
    for _dx in range(-1, 2):
      for _dz in range(-1, 2):
        if _dx == 0 and _dz == 0:
          continue
        with execute(f"positioned ~{_dx} ~ ~{_dz} align xyz"):
          tmp = 0
          f'execute store success score {tmp} unless block ~ ~ ~ #minecraft:air unless entity {Cell.select(dx=0, dy=0, dz=0)}'
          if tmp:
            Cell.summon(_tag="new_cell", _pos="~.5 ~.5 ~.5")

  @mcfunction
  def check_neighbors(self):
    """
    æ£€æŸ¥é‚»å±…æ•°é‡
    """
    num_neighbors = Score(0)
    tmp = Score()
    for _dx in range(-1, 2):
      for _dz in range(-1, 2):
        if _dx == 0 and _dz == 0:
          continue
        f'execute store success score {tmp} positioned ~{_dx} ~ ~{_dz} align xyz if block ~ ~ ~ {BLOCK_FILLED}'
        num_neighbors += tmp
    if num_neighbors < MIN_NEB or num_neighbors > MAX_NEB:
      f'tag @s add dead_cell'
    else:
      f'execute store success score {tmp} if entity @s[tag=new_cell]'
      if tmp and num_neighbors != NEW_NEB:
        f'tag @s add dead_cell'

  @staticmethod
  @mcfunction.manual
  def tick():
    """
    è®©æ‰€æœ‰ç»†èƒå®Œæˆä¸€æ¬¡è¿­ä»£ï¼Œæ­¤å‡½æ•°å¯ä»¥æ‰‹åŠ¨è§¦å‘
    """
    Cell.select().try_expand()  # æ‰€æœ‰ç»†èƒå…ˆå°è¯•æ‰©å±•
    Cell.select().check_neighbors()  # æ›´æ–°æ‰€æœ‰ç»†èƒçš„çŠ¶æ€
    f'execute at @e[tag=dead_cell] run setblock ~ ~ ~ {BLOCK_EMPTY}'
    f'kill @e[tag=dead_cell]'
    f'execute at @e[tag=new_cell] run setblock ~ ~ ~ {BLOCK_FILLED}'
    f'tag @e[tag=new_cell] remove new_cell'


class Operator(Player):
  """
  æ“ä½œè€…ï¼Œç»§æ‰¿è‡ªç©å®¶
  """

  # Q é”®è®¡åˆ†æ¿
  key_q = Score(AtS(), ScoreBoard("gol.q", f"minecraft.dropped:minecraft.carrot_on_a_stick"))
  # å³é”®è®¡åˆ†æ¿
  key_rmb = Score(AtS(), ScoreBoard("gol.rmb", f"minecraft.used:minecraft.carrot_on_a_stick"))
  # æ˜¯å¦åˆå§‹åŒ–
  init = Score(AtS(), "gol.init")

  @mcfunction
  def try_init(self):
    """
    åˆå§‹åŒ–åˆæ¬¡è¿›å…¥ä¸–ç•Œçš„ç©å®¶
    """
    # noinspection PyComparisonWithNone
    if self.init == None:  # åˆ¤æ–­æ˜¯å¦æœªå­˜åœ¨ init å€¼ï¼ˆä¸èƒ½ç”¨ is Noneï¼‰
      self.init = 1
      self.key_q = 0
      self.key_rmb = 0
      f'tp {self} {W / 2} 120 {L / 2}'
      self.give_wand()

  @mcfunction
  def detect_keys(self):
    """
    æ£€æµ‹ç©å®¶æŒ‰é”®
    """
    global running

    if self.key_q:
      self.key_q = 0
      running = not running
      f'kill @e[type=minecraft:item]'
      self.give_wand()
      if running:
        f'tellraw @a "å¼€å§‹è¿­ä»£"'
      else:
        f'tellraw @a "æš‚åœè¿­ä»£"'

    if self.key_rmb:
      self.key_rmb = 0
      if running:
        f'tellraw @s {text_component("ä¸èƒ½åœ¨æ¸¸æˆè¿›è¡Œçš„åŒæ—¶ç¼–è¾‘ç”»å¸ƒï¼", color="yellow")}'
      else:
        self.change_looking_cell()

  @mcfunction
  def change_looking_cell(self):
    """
    æ”¹å˜ç©å®¶è§†çº¿ä½ç½®å¤„çš„ç»†èƒçŠ¶æ€
    """

    @mcfunction
    def recu(dist: Score):
      """
      é€’å½’å‰è¿›ï¼Œç›´åˆ°é‡åˆ°æ–¹å—æˆ–è¶…å‡ºæœ€å¤§è·ç¦»
      """
      if dist <= 0:
        return

      tmp = Score()
      f'execute store success score {tmp} unless block ~ ~ ~ #minecraft:air'
      if tmp:
        f'execute store success score {tmp} align xyz if entity {Cell.select(dx=0, dy=0, dz=0)}'
        if tmp:
          f'execute align xyz run kill {Cell.select(dx=0, dy=0, dz=0)}'
          f'setblock ~ ~ ~ {BLOCK_EMPTY}'
        else:
          with execute("align xyz positioned ~.5 ~.5 ~.5"):
            Cell.summon()
          f'setblock ~ ~ ~ {BLOCK_FILLED}'
        return

      with execute("positioned ^ ^ ^.5"):
        recu(dist - 1)

    with execute("at @s anchored eyes positioned ^ ^ ^"):
      recu(Score(MAX_DIST * 2))

  @mcfunction.inline
  def give_wand(self):
    """
    ç»™ç©å®¶é­”æ³•æ£’
    """
    f'item replace entity {self} weapon.mainhand with minecraft:carrot_on_a_stick'


@mcfunction.load
def load():
  """
  å…¨å±€çš„åˆå§‹åŒ–å‡½æ•°
  """
  global running
  running = False
  f'kill {Cell.select()}'
  f'forceload add 0 0 {W - 1} {L - 1}'
  f'fill 0 100 0 {W - 1} 100 {L - 1} {BLOCK_EMPTY}'


@mcfunction.tick
def tick():
  """
  å…¨å±€çš„ tick å‡½æ•°
  """
  Operator.select().try_init()
  Operator.select().detect_keys()
  if running:
    Cell.tick()


# ===============================

project.build()
```

## ç¬¬ä¸‰æ–¹åº“

- [nbtlib](https://github.com/vberlier/nbtlib)
- [graphviz](https://github.com/xflr6/graphviz) ï¼ˆå¯é€‰ï¼‰
- [dominate](https://github.com/Knio/dominate) ï¼ˆå¯é€‰ï¼‰

## å¼€æºè®¸å¯

- src/pymcf/mc/commands æ–‡ä»¶å¤¹ç”± [Command-Block-Assembly](https://github.com/simon816/Command-Block-Assembly) é¡¹ç›®éƒ¨åˆ†å†…å®¹æ•´åˆè€Œæ¥ï¼ŒåŸé¡¹ç›®ä½¿ç”¨ MIT åè®®å¼€æºã€‚
