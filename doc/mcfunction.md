# mcfunction

`@mcfunction`装饰器是 pymcf 的核心功能之一，大部分 pymcf 语言特性需要在此装饰器下工作。

此装饰器装饰的函数将会被编译为一个或一组 mcfunction 文件。

下文中没有特别指出时，“函数”一词指代被 `@mcfunction` 装饰的函数。

## 定义和调用

函数的定义方式和 python 函数相同，可以将其定义为类的方法，可以和 `@classmethod`，`@staticmethod` 等装饰器共同使用。

当函数被定义为实体（Entity）类的方法时，调用此方法会自动将函数执行者设置为实体对象。

函数体和 python 函数的函数体构成相同，此外支持 pymcf 语言特性。

函数的调用方式和 python 函数相同。

## 传参

函数参数可以有编译期量或运行期量，可以以任意的参数形式定义（仅位置参数，键值对参数等）。参数类型注解不是必须提供，但建议填写。参数的类型以调用时传入的类型为准，目前注解仅用于提供类型提示。

当传入的参数是运行期量时，会按值传递，即函数内对参数进行修改不会影响到调用方传入的值（内联函数除外）。当传入的参数是编译期量时，按 python 的传参方式传递。传入的编译期量**应当作为只读数据使用**，除非你清楚你在做什么。当函数拥有 nonlocal 的值时，这些值也会被视为参数的一部分。

函数会对每一组不同的参数单独生成函数体，并缓存参数组-返回值对，若下次传入相同的参数则会直接返回缓存的返回值。运行期参数是否相等按其类型进行判定，编译期参数直接使用 `==` 进行判定。

## 返回值

函数返回值可以是运行期量或编译期量。若不存在显式的 `return` 语句，默认返回 `None`。函数定义时返回值类型注解不是必须提供，但建议填写。

当函数返回的值是运行期量时，需要保证所有 `return` 语句返回的量是相同类型，否则引发编译错误。当函数返回的值是编译期量时，需要保证所有 `return` 语句返回的量相等，否则引发编译错误。

# mcfunction 变体

## 手动函数

**@mcfunction.manual**

此类函数用作手动调用的入口，因此不能有参数。编译完成后对应的 mcfunction 函数名为 <工程名>:<函数定义模组名>/<函数全名>。

## Load 函数

**@mcfunction.load**

此类函数在数据包加载时自动调用一次，不能有参数。

## Tick 函数

**@mcfunction.tick**

此类函数在数据包加载后每个游戏刻自动调用一次，不能有参数。

## 内联函数

**@mcfunction.inline**

内联函数可以减少参数传递和函数调用的过程，调用时相当于在调用处就地展开了函数的内容。

内联函数不会单独创建函数作用域，不会缓存传入的参数组。每次调用方被编译时内联函数都会被编译，因此内联函数不能无条件递归调用。

## 宏函数

**@mcfunction.macro**

此类函数将以宏函数的方式进行调用。函数参数中允许存在多个 `Macro` 类型的参数，这些参数在插入原生函数时将被处理为宏参数。

目前宏参数只能用于插入在内联命令中，并且需要在内联的命令前添加`$`表示此命令为宏命令。

只有通过传参的方式提供的宏参数可以在当前函数内使用。
